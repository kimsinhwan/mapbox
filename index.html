<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>위치 정보 및 지도</title>
<!-- 카카오 지도 SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=752d860f5671589d0e5978adbf3e35f8"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    display: flex;
    height: 100vh;
    font-family: Arial, sans-serif;
  }
  #leftMap {
    flex: 1;
    position: relative;
  }
  #mainMap {
    width: 100%;
    height: 100%;
  }
  #rightPanel {
    width: 300px;
    display: flex;
    flex-direction: column;
    border-left: 1px solid #ccc;
    padding: 10px;
    box-sizing: border-box;
  }
  #miniMap {
    width: 100%;
    height: 200px;
    margin-bottom: 10px;
  }
  #locationText {
    font-size: 1em;
    word-break: break-all;
  }
</style>
</head>
<body>

<div id="leftMap">
  <div id="mainMap"></div>
</div>
<div id="rightPanel">
  <div id="miniMap"></div>
  <div id="locationText">로딩 중...</div>
</div>

<script>
  // 카카오 지도 API 키
  const kakaoApiKey = '752d860f5671589d0e5978adbf3e35f8';

  // 초기 지도 생성 (메인 지도)
  const mainMapContainer = document.getElementById('mainMap');
  const mainMapOption = {
    center: new kakao.maps.LatLng(37.532600, 127.024612), // 서울
    level: 4 // 적당한 확대 레벨
  };
  const mainMap = new kakao.maps.Map(mainMapContainer, mainMapOption);

  // 작은 지도 (현재 위치 표시용)
  const miniMapContainer = document.getElementById('miniMap');
  const miniMapOption = {
    center: new kakao.maps.LatLng(37.532600, 127.024612),
    level: 4,
    disableDoubleClickZoom: true,
    draggable: false,
    scrollwheel: false,
    disableDoubleClickZoom: true,
    disableDoubleClickZoom: true
  };
  const miniMap = new kakao.maps.Map(miniMapContainer, miniMapOption);

  let mainMarker = null;
  let miniMarker = null;

  // 위치 감시
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const latlng = new kakao.maps.LatLng(lat, lon);

        // 메인 지도 중심 이동 및 확대
        mainMap.setCenter(latlng);
        mainMap.setLevel(4); // 필요시 조절

        // 마커 업데이트 또는 생성
        if (mainMarker) {
          mainMarker.setPosition(latlng);
        } else {
          mainMarker = new kakao.maps.Marker({ position: latlng });
          mainMarker.setMap(mainMap);
        }

        // 작은 지도 중심 이동 및 마커
        miniMap.setCenter(latlng);
        if (miniMarker) {
          miniMarker.setPosition(latlng);
        } else {
          miniMarker = new kakao.maps.Marker({ position: latlng });
          miniMarker.setMap(miniMap);
        }

        // 서버로 위치 전송
        fetch('http://192.168.219.108:3000/save-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat: lat, lon: lon })
        });

        // 위치 텍스트 업데이트
        document.getElementById('locationText').innerText = `위도: ${lat.toFixed(6)}, 경도: ${lon.toFixed(6)}`;
      },
      function(error) {
        alert('위치 정보를 가져올 수 없습니다.');
        console.error(error);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      }
    );
  } else {
    alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
  }

  // 서버에서 위치 텍스트 읽기 (3초마다 갱신)
  async function fetchLocation() {
    try {
      const response = await fetch('http://192.168.219.108:3000/location.txt');
      const text = await response.text();
      document.getElementById('locationText').innerText = text;
    } catch (error) {
      document.getElementById('locationText').innerText = '데이터를 불러오지 못했습니다.';
    }
  }
  setInterval(fetchLocation, 3000);
</script>

</body>
</html>